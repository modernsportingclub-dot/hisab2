<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>পুজো ম্যানেজমেন্ট সিস্টেম</title>
    
    <!-- ফন্ট -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- আইকন -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Excel Reader Library (For Legacy Upload) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        siliguri: ['"Hind Siliguri"', 'sans-serif'],
                    },
                    colors: {
                        puja: {
                            red: '#D9381E',
                            orange: '#F2A900',
                            light: '#FFF5E1',
                            dark: '#8B0000',
                            purple: '#7E22CE'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #f8f9fa; }
        
        /* নেভিগেশন স্টাইল */
        .nav-link {
            padding: 0.75rem 1rem;
            color: white;
            opacity: 0.9;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
        }
        .nav-link:hover { opacity: 1; background-color: rgba(255,255,255,0.1); }
        .nav-link.active { opacity: 1; border-bottom-color: #F2A900; background-color: rgba(0,0,0,0.2); font-weight: 700; }

        /* সাব ট্যাব স্টাইল */
        .sub-tab-btn { border-bottom: 2px solid transparent; color: #6b7280; transition: all 0.2s; }
        .sub-tab-btn.active { border-bottom-color: #D9381E; color: #D9381E; font-weight: 700; }

        /* টেবিল স্টাইল */
       .spreadsheet-table th { background-color: #e5e7eb; border: 1px solid #d1d5db; padding: 10px; text-align: left; font-weight: 600; white-space: nowrap; }
        .spreadsheet-table td { border: 1px solid #d1d5db; padding: 8px; background-color: white; }
        .cursor-pointer:hover td { background-color: #f0f9ff; }
        
        /* সাজেশনে বক্স */
        .suggestion-box { position: absolute; background: white; border: 1px solid #ddd; z-index: 50; width: 100%; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
        .suggestion-box-top { position: absolute; bottom: 100%; left: 0; background: white; border: 1px solid #ddd; z-index: 50; width: 100%; max-height: 150px; overflow-y: auto; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); border-radius: 8px 8px 0 0; margin-bottom: 2px; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background-color: #fef2f2; }
        
        body { 
    font-family: 'Hind Siliguri', sans-serif; 
    background-color: #f8f9fa; 
    overscroll-behavior-y: none; /* এই লাইনটি যোগ করুন */
}
    </style>
</head>
<body class="text-gray-800 h-[100dvh] flex flex-col font-siliguri overflow-hidden">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-puja-light z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-puja-red">
            <h1 class="text-3xl font-bold text-center text-puja-red mb-2"></h1><div class="flex items-center gap-2"><i data-lucide="flower-2" class="w-9 h-6 text-yellow-300"></i><h1 class="text-xl font-bold"> মডার্ণ স্পোর্টিং ক্লাব </h1></div>
            <p class="text-center text-gray-500 mb-6">লগইন ক্রেডেনশিয়াল দিন</p>
            <div class="space-y-4">
                <div class="flex gap-4 p-2 bg-gray-50 rounded">
                    <label class="flex items-center cursor-pointer"><input type="radio" name="loginType" value="admin" checked class="mr-2 accent-puja-red"> Admin</label>
                    <label class="flex items-center cursor-pointer"><input type="radio" name="loginType" value="member" class="mr-2 accent-puja-red"> Member</label>
                </div>
                <input type="text" id="loginId" class="w-full border p-2 rounded" value="" placeholder="Login ID">
                <input type="password" id="loginPass" class="w-full border p-2 rounded" value="" placeholder="Password">
                <button onclick="handleLogin()" class="w-full bg-puja-red hover:bg-red-700 text-white font-bold py-2 rounded shadow-lg">লগইন করুন</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-container" class="hidden flex flex-col h-full w-full">
        <!-- HEADER -->
        <header class="bg-puja-red text-white shadow-lg z-40 shrink-0">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center py-2 border-b border-white/20">
                  <div class="flex items-center gap-2">
    <i data-lucide="flower-2" class="w-6 h-6 text-yellow-300"></i>
    <h1 class="text-xl font-bold"> মডার্ণ স্পোর্টিং ক্লাব </h1>
    
    <button onclick="handleManualRefresh()" class="ml-2 bg-white/20 hover:bg-white/40 text-white p-1.5 rounded-full transition-all shadow-sm border border-white/30" title="Refresh Data">
        <i data-lucide="refresh-cw" id="refreshSpinner" class="w-4 h-4"></i>
    </button>
</div>
                    <div class="flex items-center gap-4 text-sm"><span id="user-display-name">Admin</span><button onclick="logout()" class="hover:text-yellow-200">Logout</button></div>
                </div>
                <!-- NAVIGATION -->
                <nav class="flex gap-1 overflow-x-auto pt-2">
                    <button onclick="switchTab('income')" class="nav-link active" id="nav-income"><i data-lucide="indian-rupee" class="w-4 h-4 inline mr-1"></i> আয়ের হিসাব</button>
                    <button onclick="switchTab('expense')" class="nav-link" id="nav-expense"><i data-lucide="shopping-cart" class="w-4 h-4 inline mr-1"></i> ব্যয়ের হিসাব</button>
                    <button onclick="switchTab('report')" class="nav-link" id="nav-report"><i data-lucide="file-text" class="w-4 h-4 inline mr-1"></i> রিপোর্ট</button>
                    <button onclick="switchTab('settings')" class="nav-link" id="nav-settings"><i data-lucide="settings" class="w-4 h-4 inline mr-1"></i> সেটিংস</button>
                    <button onclick="switchTab('history')" class="nav-link" id="nav-history"><i data-lucide="archive" class="w-4 h-4 inline mr-1"></i> পুরোনো হিসাব</button>
                </nav>
            </div>
        </header>

        <!-- SUB HEADER -->
        <div class="bg-white border-b px-6 py-2 flex justify-between items-center shadow-sm shrink-0">
            <div class="flex items-center gap-3">
                <label class="text-sm font-semibold text-gray-500">বর্তমান পুজো:</label>
                <select id="pujaSelect" class="border rounded px-2 py-1 text-sm bg-gray-50 font-bold text-puja-red">
                    <option>বাসন্তী পূজা ২০২৬</option><option> কালী পূজা ২০২৫</option><option>সরস্বতী পূজা ২০২৬</option>
                </select>
            </div>
            <div class="text-right"><span class="text-sm font-bold text-gray-700 block" id="today-date">--/--/----</span><span class="text-xs text-gray-500" id="today-day">বার</span></div>
        </div>

        <!-- CONTENT -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6 relative min-h-0">
            
            <div id="tab-income" class="tab-content space-y-4"> <div class="flex border-b bg-white rounded-t-lg shadow-sm px-4"> </div>
            
            <!-- INCOME TAB -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-4 md:p-6 relative min-h-0">
                <div class="flex border-b bg-white rounded-t-lg shadow-sm px-4">
                    <button onclick="switchSubTab('bill')" class="px-6 py-3 sub-tab-btn active" data-target="sub-bill">বিল প্রদান</button>
                    <button onclick="switchSubTab('collection')" class="px-6 py-3 sub-tab-btn" data-target="sub-collection">চাঁদা সংগ্রহ</button>
                    <button onclick="switchSubTab('car')" class="px-6 py-3 sub-tab-btn" data-target="sub-car">গাড়ীর চাঁদা</button>
                    <button onclick="switchSubTab('dashboard')" class="px-6 py-3 sub-tab-btn" data-target="sub-dashboard">ড্যাশবোর্ড</button>
                </div>

                <!-- 1. BILL GENERATION -->
                <div id="sub-bill" class="sub-tab-content bg-white p-6 rounded-b-lg shadow animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="block text-sm mb-1 text-gray-600">তারিখ</label><input type="date" id="billDate" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm mb-1 text-gray-600">পাড়া নির্বাচন করুন</label><select id="billPara" class="w-full border p-2 rounded bg-white"></select></div>
                    </div>
                    <div class="mb-6 relative">
                        <label class="block text-sm mb-1 font-bold text-gray-700">নাম লিখুন</label>
                        <input type="text" id="billNameInput" onkeyup="handleSmartInput(this, 'income')" class="w-full border p-3 rounded text-lg" placeholder="ইংরেজী বা বাংলায় নাম লিখুন...">
                        <div id="billNameSuggestions" class="suggestion-box hidden"></div>
                        <input type="hidden" id="billNameBangla"><input type="hidden" id="billNameEnglish">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div><label class="block text-sm mb-1 text-gray-600">ধার্য চাঁদা</label><input type="number" id="billAmount" class="w-full border p-2 rounded" placeholder="0"></div>
                        <div><label class="block text-sm mb-1 text-gray-600">অগ্রিম দান</label><input type="number" id="billAdvance" class="w-full border p-2 rounded" placeholder="0"></div>
                        <div><label class="block text-sm mb-1 text-gray-600">মন্তব্য</label><input type="text" id="billRemarks" class="w-full border p-2 rounded"></div>
                    </div>
                    <div class="flex gap-4 border-t pt-4">
                        <button onclick="saveBill()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded shadow font-bold">Save Bill</button>
                        <button onclick="clearBillForm()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">Clear</button>
                    </div>
                </div>

                <!-- 2. COLLECTION -->
                <div id="sub-collection" class="sub-tab-content hidden space-y-4">
                    <div class="bg-white p-4 rounded shadow border-l-4 border-green-600">
                        <div class="flex flex-col md:flex-row gap-4 items-end">
                            <div class="flex-1 w-full">
                                <label class="block text-xs font-bold text-gray-500 mb-1">সংগ্রহের তারিখ (Collection Date)</label>
                                <input type="date" id="collectionDate" class="w-full border p-2 rounded bg-green-50 font-bold text-green-800 cursor-pointer">
                            </div>
                            <div class="flex-1 w-full">
                                <label class="block text-xs font-bold text-gray-500 mb-1">ফিল্টার (পাড়া)</label>
                                <select id="colParaSelect" onchange="renderCollectionTable()" class="w-full border p-2 rounded cursor-pointer"><option value="all">সব পাড়া</option></select>
                            </div>
                            <div class="flex-[2] w-full">
                                <label class="block text-xs font-bold text-gray-500 mb-1">খুঁজুন (Search)</label>
                                <input type="text" id="colSearch" onkeyup="renderCollectionTable()" class="w-full border p-2 rounded pl-4" placeholder="নাম বা ক্রমিক দিয়ে খুঁজুন...">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full spreadsheet-table text-sm">
                                <thead><tr><th>Date</th><th>ক্রমিক</th><th>পাড়া</th><th>ইংরেজী নাম</th><th>বাংলা নাম</th><th class="text-right">ধার্য</th><th class="text-right">প্রদেয়</th><th class="text-right">বাকী</th><th class="text-center">Action</th></tr></thead>
                                <tbody id="collectionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. CAR DONATION -->
                <div id="sub-car" class="sub-tab-content hidden space-y-4">
                    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-600">
                        <div class="flex flex-col md:flex-row gap-6 mb-6 border-b pb-4 items-start md:items-center">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">তারিখ নির্বাচন (Date)</label>
                                <input type="date" id="carEntryDate" class="border p-2 rounded bg-gray-50 font-bold text-blue-800">
                            </div>
                            <div class="flex gap-6">
                                <label class="flex items-center font-bold text-gray-700 cursor-pointer"><input type="radio" name="carType" value="Coal" checked class="mr-2 w-5 h-5 accent-blue-600"> কয়লার গাড়ী</label>
                                <label class="flex items-center font-bold text-gray-700 cursor-pointer"><input type="radio" name="carType" value="Local" class="mr-2 w-5 h-5 accent-blue-600"> লোকাল গাড়ী</label>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block text-sm font-bold mb-1 text-blue-800">গাড়ীর নম্বর</label>
                                <input type="text" id="carNumberInput" oninput="formatCarNumberDisplay(this)" class="w-full border-2 border-blue-200 p-4 rounded text-2xl uppercase font-mono" placeholder="WB11G1111">
                                <div id="carNumberSuggestions" class="suggestion-box hidden"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded border">
                                <div class="flex gap-2 mb-3">
                                    <div class="flex-1"><label class="block text-xs mb-1 font-bold">ধার্য</label><input type="number" id="carAmount" value="200" class="w-full border p-2 rounded"></div>
                                    <div class="flex-1"><label class="block text-xs mb-1 font-bold">প্রদেয়</label><input type="number" id="carPaid" oninput="calcCarDue()" class="w-full border p-2 rounded"></div>
                                    <div class="flex-1"><label class="block text-xs mb-1 font-bold">বাকী</label><input type="number" id="carDue" class="w-full border p-2 rounded bg-gray-200 font-bold text-red-600" readonly></div>
                                </div>
                                <input type="text" id="carRemarks" class="w-full border p-2 rounded text-sm" placeholder="Remarks">
                            </div>
                        </div>
                        <div class="mt-6 text-right"><button onclick="saveCarEntry()" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3 rounded font-bold shadow-lg">নতুন এন্ট্রি সেভ করুন</button></div>
                    </div>
                    <div class="bg-white rounded shadow p-4">
    
    <div class="mb-4 flex gap-2 items-center bg-blue-50 p-3 rounded border border-blue-200">
        <i data-lucide="search" class="w-5 h-5 text-blue-500"></i>
        <input type="text" id="carSearchInput" onkeyup="renderCarTable()" 
               class="w-full bg-transparent outline-none font-bold text-gray-700 placeholder-gray-400" 
               placeholder="Search by Date (dd-mm), Car No, Type or Remarks...">
    </div>
    <h4 class="font-bold mb-4 text-gray-500">সাম্প্রতিক এন্ট্রি (তালিকায় ক্লিক করে টাকা জমা নিন)</h4>
    
    <div class="overflow-x-auto">
        <table class="w-full spreadsheet-table text-sm">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Car No</th>
                    <th>Type</th>
                    <th class="text-right">Paid</th>
                    <th class="text-right">Due</th>
                    <th>Remarks</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody id="carTableBody"></tbody>
        </table>
    </div>
</div>


                <!-- 4. DASHBOARD -->
                <div id="sub-dashboard" class="sub-tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500"><div><h3 class="text-gray-500 font-bold uppercase">আজকের আয়</h3><p class="text-3xl font-bold mt-2" id="dashTodayInc">₹0</p></div></div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500"><div><h3 class="text-gray-500 font-bold uppercase">আজকের ব্যয়</h3><p class="text-3xl font-bold mt-2" id="dashTodayExp">₹0</p></div></div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500"><div><h3 class="text-gray-500 font-bold uppercase">বর্তমান স্থিতি</h3><p class="text-3xl font-bold mt-2" id="dashBalance">₹0</p></div></div>
                    </div>
                </div>
            </div>
</div>
            <!-- EXPENSE TAB -->
            <div id="tab-expense" class="tab-content hidden space-y-6">
                 <div class="flex border-b bg-white rounded-t-lg shadow-sm px-4">
                    <button onclick="switchExpSubTab('add')" class="px-6 py-3 sub-tab-btn active" data-target="sub-exp-add">নতুন খরচ</button>
                    <button onclick="switchExpSubTab('view')" class="px-6 py-3 sub-tab-btn" data-target="sub-exp-view">খরচের তালিকা (ব্যায়ে দেখুন)</button>
                </div>
                <div id="sub-exp-add" class="sub-exp-content bg-white p-8 rounded shadow max-w-3xl mx-auto border-t-4 border-red-600">
                    <h3 class="text-2xl font-bold text-red-700 mb-6 flex items-center gap-2"><i data-lucide="minus-circle" class="w-6 h-6"></i> খরচের হিসাব লিখুন</h3>
                    <div class="space-y-6">
                        <div><label class="block text-sm mb-1 font-bold text-gray-600">তারিখ</label><input type="date" id="expDate" class="w-full border p-3 rounded bg-gray-50"></div>
                        <div class="relative">
                            <label class="block text-sm mb-1 font-bold text-gray-600">খরচের কারণ (English ↔ Bangla)</label>
                            <div id="expPastSuggestions" class="suggestion-box-top hidden"></div>
                            <!-- EXPENSE INPUT FIXED -->
                            <input type="text" id="expReason" onkeyup="handleExpInput(this)" class="w-full border p-3 rounded focus:ring-2 focus:ring-red-300 outline-none" placeholder="e.g. Pandal Decoration or প্যান্ডেল">
                            <div id="expSuggestions" class="suggestion-box hidden"></div>
                        </div>
                        <div><label class="block text-sm mb-1 font-bold text-gray-600">পরিমাণ (Amount)</label><input type="number" id="expAmount" class="w-full border p-3 rounded text-xl font-mono" placeholder="₹"></div>
                        <div class="flex gap-4 pt-4">
                            <button onclick="saveExpense()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded font-bold shadow">SAVE EXPENSE</button>
                            <button onclick="document.getElementById('expReason').value=''; document.getElementById('expAmount').value=''" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded font-bold">CANCEL</button>
                        </div>
                    </div>
                </div>
                <div id="sub-exp-view" class="sub-exp-content hidden space-y-4">
                    <div class="bg-white p-4 rounded shadow">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div><label class="text-xs font-bold text-gray-500">Date From</label><input type="date" id="expStart" onchange="renderExpenseTable()" class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-gray-500">Date To</label><input type="date" id="expEnd" onchange="renderExpenseTable()" class="w-full border p-2 rounded"></div>
                            <div><label class="text-xs font-bold text-gray-500">ব্যায়ের কারণ</label><select id="expFilterReason" onchange="renderExpenseTable()" class="w-full border p-2 rounded"><option value="all">All</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">Search</label><input type="text" id="expSearch" onkeyup="renderExpenseTable()" class="w-full border p-2 rounded" placeholder="Keyword..."></div>
                        </div>
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden">
                        <table class="w-full spreadsheet-table text-sm">
                            <thead><tr><th>Date</th><th>Reason</th><th class="text-right">Amount</th><th class="text-center">Action</th></tr></thead>
                            <tbody id="expenseTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- REPORT TAB -->
   <div id="tab-report" class="tab-content hidden">
    <div class="bg-white p-6 rounded shadow h-full flex flex-col items-center max-w-3xl mx-auto mt-4 overflow-y-auto">
        
        <div class="w-full border-b pb-4 mb-4 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-700"><i data-lucide="file-bar-chart" class="inline w-6 h-6 mr-2"></i>অ্যাডভান্সড রিপোর্ট</h2>
    <div class="flex gap-2">
        <button onclick="printReportResult()" id="printBtn" class="hidden bg-gray-700 text-white px-4 py-1 rounded text-sm hover:bg-black font-bold">
            <i data-lucide="printer" class="w-4 h-4 inline mr-1"></i> Print
        </button>
        <button onclick="downloadReportPDF()" id="pdfBtn" class="hidden bg-red-700 text-white px-4 py-1 rounded text-sm hover:bg-red-900 font-bold">
            <i data-lucide="file-down" class="w-4 h-4 inline mr-1"></i> PDF
        </button>
    </div>
</div>

        <div class="w-full bg-blue-50 p-4 rounded border border-blue-200 mb-6 space-y-4">
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-500 block mb-1">তারিখ হতে (From)</label>
                    <input type="date" class="w-full border p-2 rounded bg-white" id="repStart">
                </div>
                <div class="flex-1">
                    <label class="text-xs font-bold text-gray-500 block mb-1">তারিখ পর্যন্ত (To)</label>
                    <input type="date" class="w-full border p-2 rounded bg-white" id="repEnd">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 block mb-1">হিসাবের ধরন</label>
                    <select id="repType" onchange="handleReportUI()" class="w-full border p-2 rounded font-bold text-gray-700">
                        <option value="income">আয় (Income)</option>
                        <option value="expense">ব্যায় (Expense)</option>
                    </select>
                </div>
                
                <div id="repSourceBox">
                    <label class="text-xs font-bold text-gray-500 block mb-1">উৎস (Source)</label>
                    <select id="repSource" onchange="handleReportUI()" class="w-full border p-2 rounded">
                        <option value="all">সব (All Sources)</option>
                        <option value="para">পাড়া (Para Collection)</option>
                        <option value="car">গাড়ী (Car Donation)</option>
                    </select>
                </div>
            </div>

            <div id="repSubFilters" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div id="repParaListBox" class="hidden">
                    <label class="text-xs font-bold text-gray-500 block mb-1">কোন পাড়া?</label>
                    <select id="repParaSelect" class="w-full border p-2 rounded text-blue-700 font-bold">
                        <option value="all">সব পাড়া (All Paras)</option>
                        </select>
                </div>

                <div id="repStatusBox" class="w-full">
                    <label class="text-xs font-bold text-gray-500 block mb-1">টাকা দেওয়ার অবস্থা (Status)</label>
                    <select id="repStatus" class="w-full border p-2 rounded">
                        <option value="all">সব (All)</option>
                        <option value="paid">টাকা দিয়েছে (Paid/Partial)</option>
                        <option value="due">বাকী আছে (Has Due)</option>
                        <option value="zero">মোটেই দেয়নি (Zero Paid)</option>
                    </select>
                </div>
            </div>

            <button onclick="generateReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold shadow mt-2">
                রিপোর্ট দেখুন (Generate View)
            </button>
        </div>

        <div id="reportResultArea" class="w-full overflow-x-auto hidden border-t pt-4">
             <div class="flex justify-between items-end mb-2">
                <h3 class="font-bold text-lg underline" id="repResultTitle">Report Result</h3>
                <span class="text-sm font-bold bg-yellow-100 px-2 py-1 rounded border border-yellow-300">Total: <span id="repTotalDisplay">0</span></span>
             </div>
             <table class="w-full spreadsheet-table text-sm border">
                 <thead id="repTableHead" class="bg-gray-100"></thead>
                 <tbody id="repTableBody"></tbody>
             </table>
        </div>
    </div>
</div>

            <!-- SETTINGS TAB (UPDATED: Added Legacy Import) -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="bg-white p-6 rounded shadow max-w-4xl mx-auto mt-4 space-y-8">
                    <!-- Para Settings -->
                    <div>
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 class="text-xl font-bold text-gray-700">⚙️ পাড়া ও চাঁদা সেটিংস (Para Settings)</h3>
                            <button onclick="openParaModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold shadow flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> নতুন পাড়া যোগ করুন
                            </button>
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 text-gray-600 uppercase font-bold">
                                    <tr>
                                        <th class="px-6 py-3">পাড়ার নাম (Para Name)</th>
                                        <th class="px-6 py-3 text-right">ডিফল্ট ধার্য (Default Amount)</th>
                                        <th class="px-6 py-3 text-center">অ্যাকশন (Action)</th>
                                    </tr>
                                </thead>
                                <tbody id="paraSettingsTable"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Legacy Data Upload (New Feature) -->
                    <div class="bg-orange-50 p-6 rounded border border-orange-200">
                        <h3 class="text-xl font-bold text-orange-700 mb-4 flex items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-6 h-6"></i> পুরোনো হিসাব আপলোড (Legacy Upload)
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Excel ফাইল (.xlsx) সিলেক্ট করুন। আয়ের জন্য কলাম: [Source, En Name, Bn Name, Amount, Remarks]. ব্যয়ের জন্য: [Date, Reason En, Reason Bn, Amount, Remarks]</p>
                        <div class="flex gap-4 items-center">
                            <input type="file" id="legacyFile" class="border p-2 rounded bg-white">
                            <select id="legacyType" class="border p-2 rounded font-bold">
                                <option value="income">আয়ের হিসাব (Income)</option>
                                <option value="expense">ব্যয়ের হিসাব (Expense)</option>
                            </select>
                            <button onclick="processLegacyUpload()" class="bg-orange-600 text-white px-6 py-2 rounded font-bold shadow">Upload Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div id="tab-history" class="tab-content hidden space-y-6 pb-24">
                <div class="bg-white p-6 rounded shadow border-t-4 border-purple-600">
                    <h3 class="text-xl font-bold text-purple-700 mb-6 flex items-center gap-2"><i data-lucide="archive" class="w-6 h-6"></i> পুরোনো হিসাব খুঁজুন</h3>
                    <div class="bg-gray-50 p-4 rounded border mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">পুজো নির্বাচন</label><select id="histPuja" class="w-full border p-2 rounded font-bold"><option>Durga Puja</option><option>Kali Puja</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">সাল (Year)</label><select id="histYear" class="w-full border p-2 rounded font-bold"><option>2026</option><option>2025</option><option>2024</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">ধরন</label><select id="histType" onchange="toggleHistoryFilters()" class="w-full border p-2 rounded font-bold"><option value="income">আয়</option><option value="expense">ব্যায়</option></select></div>
                            <div id="histSourceBox"><label class="text-xs font-bold text-gray-500">উৎস</label><select id="histSource" class="w-full border p-2 rounded font-bold"><option value="all">সব</option><option value="para">পাড়ার নাম</option><option value="car">গাড়ী</option></select></div>
                        </div>
                    </div>
                    <div class="flex gap-4 mb-6"><input type="text" id="histSearch" class="flex-1 border p-3 rounded" placeholder="Search..."><button onclick="searchHistory()" class="bg-purple-600 text-white px-8 py-2 rounded font-bold">খুঁজুন</button></div>
                    <div class="overflow-x-auto border rounded"><table class="w-full spreadsheet-table text-sm"><thead><tr class="bg-purple-50"><th>তারিখ</th><th>বিবরণ</th><th>উৎস</th><th class="text-right">পরিমাণ</th><th>মন্তব্য</th></tr></thead><tbody id="historyTableBody"></tbody><tfoot id="historyTotal" class="bg-gray-100 font-bold hidden"><tr><td colspan="3" class="text-right p-3">মোট:</td><td class="text-right p-3 text-purple-700 text-lg" id="histTotalAmount">0</td><td></td></tr></tfoot></table></div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- COLLECTION PAYMENT -->
    <div id="collectionModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-1 text-puja-red">চাঁদা জমা নিন</h3>
            <p id="colModalName" class="text-sm text-gray-500 font-bold border-b pb-4 mb-4"></p>
            <input type="hidden" id="colModalId">
            <div class="mb-4"><label class="block text-sm font-bold mb-1">নতুন জমা (New Payment)</label><input type="number" id="colModalPay" class="w-full border-2 border-green-100 p-2 rounded focus:border-green-500 text-lg"></div>
            <div class="mb-6"><label class="block text-sm font-bold mb-1">মন্তব্য</label><input type="text" id="colModalRemarks" class="w-full border p-2 rounded"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('collectionModal')" class="px-4 py-2 border rounded">Cancel</button><button onclick="saveCollectionPayment()" class="px-6 py-2 bg-green-600 text-white rounded font-bold">Deposit</button></div>
        </div>
    </div>

    <!-- FULL EDIT -->
    <div id="fullEditModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4 text-blue-600">তথ্য পরিবর্তন করুন (Full Edit)</h3>
            <input type="hidden" id="editFullId">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-xs font-bold">English Name</label><input type="text" id="editFullEn" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold">Bangla Name</label><input type="text" id="editFullBn" class="w-full border p-2 rounded"></div>
            </div>
            <div class="mb-4"><label class="text-xs font-bold">Para</label><select id="editFullPara" class="w-full border p-2 rounded"></select></div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div><label class="text-xs font-bold">ধার্য (Projected)</label><input type="number" id="editFullProj" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold">জমা (Paid)</label><input type="number" id="editFullPaid" class="w-full border p-2 rounded"></div>
            </div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('fullEditModal')" class="px-4 py-2 border rounded">Cancel</button><button onclick="saveFullEdit()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold">Update All</button></div>
        </div>
    </div>

    <!-- EXPENSE EDIT -->
    <div id="expenseEditModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-red-600">খরচ এডিট করুন</h3>
            <input type="hidden" id="editExpId">
            <div class="mb-4"><label class="text-xs font-bold">তারিখ</label><input type="date" id="editExpDate" class="w-full border p-2 rounded"></div>
            <div class="mb-4"><label class="text-xs font-bold">কারণ</label><input type="text" id="editExpReason" class="w-full border p-2 rounded"></div>
            <div class="mb-4"><label class="text-xs font-bold">পরিমাণ</label><input type="number" id="editExpAmount" class="w-full border p-2 rounded"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('expenseEditModal')" class="px-4 py-2 border rounded">Cancel</button><button onclick="saveExpenseEdit()" class="px-6 py-2 bg-red-600 text-white rounded font-bold">Update</button></div>
        </div>
    </div>

    <!-- CAR PAYMENT -->
    <div id="carPaymentModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md border-t-4 border-blue-600">
            <h3 class="text-xl font-bold mb-2 text-blue-800">গাড়ির চাঁদা আপডেট</h3>
            <p id="carPayTitle" class="text-sm font-mono font-bold text-gray-600 border-b pb-4 mb-4"></p>
            <input type="hidden" id="carPayId">
            <div class="bg-blue-50 p-3 rounded mb-4 text-sm">
                <div class="flex justify-between"><span>মোট ধার্য:</span> <span class="font-bold" id="cpTotal">0</span></div>
                <div class="flex justify-between"><span>ইতিমধ্যে জমা:</span> <span class="font-bold text-green-600" id="cpPaid">0</span></div>
                <div class="flex justify-between border-t border-blue-200 mt-1 pt-1"><span>বর্তমান বাকী:</span> <span class="font-bold text-red-600" id="cpDue">0</span></div>
            </div>
            <div class="mb-4"><label class="block text-sm font-bold mb-1">নতুন জমা (Add Amount)</label><input type="number" id="carNewPay" class="w-full border-2 border-green-100 p-2 rounded focus:border-green-500 text-lg" placeholder="আরও কত জমা দিচ্ছে?"></div>
            <div class="mb-6"><label class="block text-sm font-bold mb-1">নতুন মন্তব্য</label><input type="text" id="carNewRem" class="w-full border p-2 rounded"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('carPaymentModal')" class="px-4 py-2 border rounded">Cancel</button><button onclick="saveCarPayment()" class="px-6 py-2 bg-green-600 text-white rounded font-bold">Deposit Update</button></div>
        </div>
    </div>

    <!-- CAR EDIT -->
    <div id="carEditModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-purple-600">গাড়ির তথ্য পরিবর্তন</h3>
            <input type="hidden" id="ceId">
            <div class="mb-3"><label class="text-xs font-bold">তারিখ</label><input type="date" id="ceDate" class="w-full border p-2 rounded"></div>
            <div class="mb-3"><label class="text-xs font-bold">গাড়ীর নং</label><input type="text" id="ceNo" class="w-full border p-2 rounded font-mono uppercase"></div>
            <div class="mb-3"><label class="text-xs font-bold">টাইপ</label><select id="ceType" class="w-full border p-2 rounded"><option value="Coal">Coal</option><option value="Local">Local</option></select></div>
            <div class="flex gap-2 mb-3">
                <div><label class="text-xs font-bold">ধার্য</label><input type="number" id="ceAmount" class="w-full border p-2 rounded"></div>
                <div><label class="text-xs font-bold">জমা</label><input type="number" id="cePaid" class="w-full border p-2 rounded"></div>
            </div>
            <div class="mb-4"><label class="text-xs font-bold">মন্তব্য</label><input type="text" id="ceRem" class="w-full border p-2 rounded"></div>
            <div class="flex justify-end gap-3"><button onclick="closeModal('carEditModal')" class="px-4 py-2 border rounded">Cancel</button><button onclick="saveCarFullEdit()" class="px-6 py-2 bg-purple-600 text-white rounded font-bold">Update All</button></div>
        </div>
    </div>

    <!-- PARA MODAL -->
    <div id="paraModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md border-t-4 border-blue-600">
            <h3 class="text-xl font-bold mb-4 text-gray-800" id="paraModalTitle">নতুন পাড়া যুক্ত করুন</h3>
            <input type="hidden" id="paraEditIndex"> 
            <div class="space-y-4">
                <div><label class="block text-sm font-bold mb-1 text-gray-600">পাড়ার নাম (Para Name)</label><input type="text" id="paraNameInput" class="w-full border p-3 rounded focus:ring-2 focus:ring-blue-300" placeholder="e.g. North Para"></div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-600">ডিফল্ট ধার্য (Default Amount)</label>
                    <input type="number" id="paraAmountInput" class="w-full border p-3 rounded focus:ring-2 focus:ring-blue-300" placeholder="e.g. 500">
                    <p class="text-xs text-gray-400 mt-1">* বিল করার সময় এই টাকা অটোমেটিক চলে আসবে</p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6"><button onclick="closeModal('paraModal')" class="px-4 py-2 border rounded hover:bg-gray-100">বাতিল (Cancel)</button><button onclick="savePara()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 shadow">সেভ করুন</button></div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTvlUkPgP0z2k2rx0mmoCATCX6IE9-LdBcsDwIbBb3aqk0ADZX1TORZq3S5jJxQlX-SA/exec"; 
    // --- তারিখ ঠিক করার নতুন ফাংশন ---
function setLocalTodayDate(elementId) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    const el = document.getElementById(elementId);
    if(el) el.value = todayStr;
}
// --- DATE HELPER (তারিখ ঠিক করার মেশিন) ---
function normalizeDate(dateStr) {
    if (!dateStr) return new Date().toISOString().split('T')[0];
    
    // যদি ইতিমধ্যেই YYYY-MM-DD ফরম্যাটে থাকে
    if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) return dateStr;

    // যদি DD/MM/YYYY বা DD-MM-YYYY বা D/M/YY হয়
    const parts = dateStr.split(/[-/.]/);
    if (parts.length === 3) {
        let day = parts[0].padStart(2, '0');
        let month = parts[1].padStart(2, '0');
        let year = parts[2];
        if (year.length === 2) year = '20' + year; // 24 -> 2024
        return `${year}-${month}-${day}`;
    }

    // অন্য কোনো ফরম্যাট হলে জাভাস্ক্রিপ্টকে চেষ্টা করতে দিন
    try {
        return new Date(dateStr).toISOString().split('T')[0];
    } catch (e) {
        return dateStr; // ব্যর্থ হলে যা আছে তাই ফেরত দিক
    }
}
    // --- GLOBAL STATE ---
    let globalData = { income: [], expense: [], car: [], paras: [] };
    let currentRole = null;

    // --- API FUNCTIONS ---
    function sendToSheet(action, type, payload) {
        const dataToSend = { action: action, type: type, payload: payload };
        console.log("Sending...", dataToSend);
        fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(dataToSend) })
        .then(res => res.text()).then(data => console.log("Server:", data))
        .catch(err => console.error("Save Failed:", err));
    }

    async function fetchAllData() {
        document.body.style.cursor = 'wait'; 
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            
            globalData.income = data.income;
            globalData.expense = data.expense;
            globalData.car = data.car;
            globalData.paras = (data.paras && data.paras.length > 0) ? data.paras : ["North Para", "South Para"];
            
            localStorage.setItem('pujaDataCache', JSON.stringify(globalData));
            console.log("Data Synced & Cached");
            refreshUI();
        } catch (error) { console.error("Fetch failed", error); } 
        finally { document.body.style.cursor = 'default'; }
    }

    // --- STORE ---
    const store = {
        getIncome: () => globalData.income || [],
        setIncome: (data) => { globalData.income = data; },
        getCar: () => globalData.car || [],
        setCar: (data) => { globalData.car = data; },
        getExpense: () => globalData.expense || [],
        setExpense: (data) => { globalData.expense = data; },
        getParas: () => globalData.paras || [],
        setParas: (list) => {
            globalData.paras = list;
            sendToSheet('save_settings', 'settings', list);
        }
    };

    // --- HELPERS ---
    function parseParaData(p) {
        let name = "Unknown"; let amount = 0;
        if (typeof p === 'object') { name = p.name || p; amount = p.amount || 0; } 
        else if (typeof p === 'string') {
            if (p.includes('name=')) {
                let cleanText = p;
                while(cleanText.includes('name=')) {
                    const match = cleanText.match(/name=([^,{}]+)/);
                    if (match) cleanText = match[1]; else break;
                }
                name = cleanText;
                const amtMatch = p.match(/amount=(\d+)/);
                if (amtMatch) amount = Number(amtMatch[1]);
            } else { name = p; }
        }
        return { name: name.trim(), amount: amount };
    }

    function refreshUI() {
        initDropdowns();
        renderCollectionTable(); 
        renderExpenseTable();
        renderCarTable();
        renderParaSettings();
        updateDashboard();
    }

    function init() {
        setLocalTodayDate('billDate'); setLocalTodayDate('expDate'); setLocalTodayDate('carEntryDate'); setLocalTodayDate('collectionDate');

        const cached = localStorage.getItem('pujaDataCache');
        if (cached) {
            try {
                globalData = JSON.parse(cached);
                console.log("Loaded from Cache");
                refreshUI();
            } catch(e) {}
        }
        console.log("Fetching fresh data...");
        fetchAllData();
    }

    // --- TRANSLITERATION (Fixes "Whale's Nose") ---
    function transliterateBanglaToEnglish(text) {
        const map = {
            'অ': 'a', 'আ': 'a', 'ই': 'i', 'ঈ': 'i', 'উ': 'u', 'ঊ': 'u', 'ঋ': 'ri', 'এ': 'e', 'ঐ': 'oi', 'ও': 'o', 'ঔ': 'ou',
            'ক': 'k', 'খ': 'kh', 'গ': 'g', 'ঘ': 'gh', 'ঙ': 'ng', 'চ': 'ch', 'ছ': 'chh', 'জ': 'j', 'ঝ': 'jh', 'ঞ': 'n',
            'ট': 't', 'ঠ': 'th', 'ড': 'd', 'ঢ': 'dh', 'ণ': 'n', 'ত': 't', 'থ': 'th', 'দ': 'd', 'ধ': 'dh', 'ন': 'n',
            'প': 'p', 'ফ': 'ph', 'ব': 'b', 'ভ': 'bh', 'ম': 'm', 'য': 'y', 'র': 'r', 'ল': 'l', 'শ': 'sh', 'ষ': 'sh', 'স': 's', 'হ': 'h',
            'ড়': 'r', 'ঢ়': 'rh', 'য়': 'y', 'ৎ': 't', 'ং': 'ng', 'ঃ': 'h', 'ঁ': 'n', 'া': 'a', 'ি': 'i', 'ী': 'i', 'ু': 'u', 'ূ': 'u', 'ৃ': 'ri', 'ে': 'e', 'ৈ': 'oi', 'ো': 'o', 'ৌ': 'ou', '্': '', 
        };
        let result = '';
        for (let i = 0; i < text.length; i++) {
            let char = text[i]; let nextChar = text[i + 1];
            if (map[char] !== undefined) {
                result += map[char];
                if (isConsonant(char)) {
                    if (!nextChar || !isMatraOrVirama(nextChar)) {
                        if (char !== 'ং' && char !== 'ঃ' && char !== 'ঁ') { result += 'a'; }
                    }
                }
            } else { result += char; }
        }
        return result.replace(/a+$/g, '').replace(/aa/g, 'a');
    }
    function isConsonant(char) { return (char >= 'ক' && char <= 'হ') || (char >= 'ড়' && char <= 'য়'); }
    function isMatraOrVirama(char) { return (char >= 'া' && char <= 'ৌ') || char === '্'; }
    function isBangla(str) { for (let i = 0; i < str.length; i++) { if (str.charCodeAt(i) >= 0x0980 && str.charCodeAt(i) <= 0x09FF) return true; } return false; }

    // --- SMART INPUT HANDLER ---
    async function handleSmartInput(input, type) {
        const rawVal = input.value.trim();
        const box = document.getElementById('billNameSuggestions');
        if (!rawVal) { box.classList.add('hidden'); return; }
        box.innerHTML = ''; box.classList.remove('hidden');

        const toTitleCase = (str) => str.replace(/\b\w/g, char => char.toUpperCase());
        const prettyVal = toTitleCase(rawVal); 

        if (isBangla(rawVal)) {
            let dataset = store.getIncome().map(i => ({en: i.english_name, bn: i.bengali_name}));
            const matches = dataset.filter(item => item.bn && item.bn.includes(rawVal));
            const unique = [...new Map(matches.map(item => [item['en'], item])).values()];
            unique.slice(0, 5).forEach(m => {
                const div = document.createElement('div'); div.className = 'suggestion-item';
                div.innerHTML = `<span>${m.bn}</span> <span class="text-xs font-bold text-blue-600">DB: ${m.en}</span>`;
                div.onclick = () => selectSmartValue(m.en, m.bn);
                box.appendChild(div);
            });

            // Custom Transliteration (No Whale's Nose)
            const autoEn = toTitleCase(transliterateBanglaToEnglish(rawVal));
            const div = document.createElement('div'); div.className = 'suggestion-item';
            div.innerHTML = `<span>${rawVal}</span> <span class="text-xs font-bold text-purple-600">Auto: ${autoEn}</span>`;
            div.onclick = () => selectSmartValue(autoEn, rawVal);
            box.appendChild(div);
            
        } else {
            try {
                const url = `https://inputtools.google.com/request?text=${encodeURIComponent(rawVal)}&itc=bn-t-i0-und&num=5&cp=0&cs=1&ie=utf-8&oe=utf-8`;
                const res = await fetch(url); const json = await res.json();
                if(json[0]==='SUCCESS'){
                    const sugs = json[1][0][1];
                    const divEn = document.createElement('div'); divEn.className = 'suggestion-item bg-gray-50';
                    divEn.innerHTML = `<span>${prettyVal}</span> <span class="text-xs">Keep English</span>`;
                    divEn.onclick = () => selectSmartValue(prettyVal, sugs[0]); 
                    box.appendChild(divEn);
                    sugs.forEach(s => {
                        const div = document.createElement('div'); div.className = 'suggestion-item';
                        div.innerHTML = `<span>${s}</span> <span class="text-xs text-green-600">Bangla</span>`;
                        div.onclick = () => selectSmartValue(prettyVal, s);
                        box.appendChild(div);
                    });
                }
            } catch(e){}
        }
    }
    function selectSmartValue(en, bn) {
        document.getElementById('billNameInput').value = `${en} | ${bn}`;
        document.getElementById('billNameEnglish').value = en;
        document.getElementById('billNameBangla').value = bn;
        document.getElementById('billNameSuggestions').classList.add('hidden');
    }

    // --- OTHER LOGIC ---
    function handleLogin() {
        const type = document.querySelector('input[name="loginType"]:checked').value;
        const id = document.getElementById('loginId').value;
        const pass = document.getElementById('loginPass').value;
        if ((type === 'admin' && id === 'admin' && pass === '1234') || (type === 'member' && id === 'member' && pass === '1234')) {
            currentRole = type;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = type === 'admin' ? "Admin" : "Member";
            if (type !== 'admin') document.getElementById('nav-settings').classList.add('hidden');
            const today = new Date();
            document.getElementById('today-date').innerText = today.toLocaleDateString('en-GB');
            document.getElementById('today-day').innerText = today.toLocaleDateString('bn-BD', { weekday: 'long' });
            init();
            switchTab('income');
            updateDashboard();
        } else { alert("ভুল ইউজার আইডি বা পাসওয়ার্ড!"); }
    }
    function logout() { location.reload(); }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`nav-${tabId}`).classList.add('active');
        if(tabId === 'income') switchSubTab('bill');
        if(tabId === 'expense') switchExpSubTab('add');
        if(tabId === 'settings') renderParaSettings();
        if(tabId === 'report') handleReportUI();
    }
    function switchSubTab(subId) {
        document.querySelectorAll('.sub-tab-btn').forEach(btn => { btn.classList.remove('active', 'border-b-2', 'border-puja-red', 'text-puja-red', 'font-bold'); btn.classList.add('text-gray-600'); });
        const btn = document.querySelector(`button[data-target="sub-${subId}"]`);
        if(btn) { btn.classList.add('active', 'border-b-2', 'border-puja-red', 'text-puja-red', 'font-bold'); btn.classList.remove('text-gray-600'); }
        document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`sub-${subId}`).classList.remove('hidden');
        if(subId === 'collection') renderCollectionTable();
        if(subId === 'car') renderCarTable();
        if(subId === 'dashboard') updateDashboard();
    }
    function switchExpSubTab(subId) {
        document.querySelectorAll('#tab-expense .sub-tab-btn').forEach(btn => { btn.classList.remove('active', 'border-b-2', 'border-puja-red', 'text-puja-red', 'font-bold'); btn.classList.add('text-gray-600'); });
        const btn = document.querySelector(`button[data-target="sub-exp-${subId}"]`);
        if(btn) { btn.classList.add('active', 'border-b-2', 'border-puja-red', 'text-puja-red', 'font-bold'); btn.classList.remove('text-gray-600'); }
        document.querySelectorAll('.sub-exp-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`sub-exp-${subId}`).classList.remove('hidden');
        if(subId === 'view') { renderExpenseTable(); initExpDropdown(); }
    }

    function initDropdowns() {
        const paras = store.getParas();
        const select = document.getElementById('billPara');
        const colSelect = document.getElementById('colParaSelect');
        const editSelect = document.getElementById('editFullPara'); 
        select.innerHTML = '<option value="">-- পাড়া নির্বাচন করুন --</option>'; 
        colSelect.innerHTML = '<option value="all">-- সব পাড়া --</option>'; 
        editSelect.innerHTML = '';
        paras.forEach(p => {
            const data = parseParaData(p);
            const opt = new Option(data.name, data.name);
            opt.setAttribute('data-amount', data.amount);
            select.add(opt);
            colSelect.add(new Option(data.name, data.name));
            editSelect.add(new Option(data.name, data.name));
        });
        select.onchange = function() {
            const selectedOpt = select.options[select.selectedIndex];
            const defAmount = selectedOpt.getAttribute('data-amount');
            if(defAmount && defAmount > 0) { document.getElementById('billAmount').value = defAmount; }
        };
    }

    // --- BILL & COLLECTION ---
    function saveBill() {
        const nameEn = document.getElementById('billNameEnglish').value || document.getElementById('billNameInput').value;
        const nameBn = document.getElementById('billNameBangla').value || nameEn;
        const para = document.getElementById('billPara').value; 
        if (!para) { alert("দয়া করে পাড়া নির্বাচন করুন!"); return; }
        if (!nameEn) { alert("নাম লিখুন!"); return; }

        const item = {
            id: Date.now().toString(), 
            date: document.getElementById('billDate').value, 
            para: para,
            english_name: nameEn, 
            bengali_name: nameBn, 
            projected: Number(document.getElementById('billAmount').value),
            paid: Number(document.getElementById('billAdvance').value), 
            due: Number(document.getElementById('billAmount').value) - Number(document.getElementById('billAdvance').value),
            remarks: document.getElementById('billRemarks').value
        };
        globalData.income.push(item); 
        sendToSheet('add', 'income', item);
        document.getElementById('billNameInput').value = ''; 
        document.getElementById('billNameEnglish').value = ''; 
        document.getElementById('billNameBangla').value = ''; 
        document.getElementById('billAmount').value = ''; 
        document.getElementById('billAdvance').value = '';
        // আগের কোড...
document.getElementById('billAdvance').value = '';

// এই লাইনটি যোগ করুন (Add this line):
document.getElementById('billDate').valueAsDate = new Date();


        alert("বিল সেভ হয়েছে!");
    }

    function renderCollectionTable() {
        const data = store.getIncome(); const tbody = document.getElementById('collectionTableBody'); tbody.innerHTML = '';
        const filterPara = document.getElementById('colParaSelect').value;
        const search = document.getElementById('colSearch').value.toLowerCase();
        let serial = 1;
        const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedData.forEach(row => {
            if (filterPara !== 'all' && row.para !== filterPara) return;
            if (search && !row.english_name.toLowerCase().includes(search) && !row.bengali_name.includes(search) && !String(serial).includes(search)) return;
            const tr = document.createElement('tr');
            tr.className = "hover:bg-blue-50 cursor-pointer transition";
            tr.onclick = (e) => { if(!e.target.closest('button')) openCollectionModal(row.id); };
            tr.innerHTML = `
               <td class="text-xs text-gray-500">${new Date(row.date).toLocaleDateString('en-GB')}</td><td class="text-center text-gray-500">${serial++}</td>
                <td>${row.para}</td><td class="font-bold text-gray-700">${row.english_name}</td><td class="font-siliguri">${row.bengali_name}</td>
                <td class="text-right font-mono">₹${row.projected}</td><td class="text-right font-mono text-green-600 font-bold">₹${row.paid}</td><td class="text-right font-mono text-red-600 font-bold">₹${row.due}</td>
                <td class="text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="openFullEditModal('${row.id}')" class="bg-blue-100 text-blue-600 p-2 rounded hover:bg-blue-600 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteIncome('${row.id}')" class="bg-red-100 text-red-600 p-2 rounded hover:bg-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        lucide.createIcons();
    }

    function openCollectionModal(id) {
        const item = store.getIncome().find(i => String(i.id) === String(id));
        if(!item) return;
        document.getElementById('colModalId').value = id;
        document.getElementById('colModalName').innerText = `${item.english_name} (${item.bengali_name}) | Due: ₹${item.due}`;
        document.getElementById('colModalPay').value = '';
        document.getElementById('collectionModal').classList.remove('hidden');
    }
    function saveCollectionPayment() {
        const id = document.getElementById('colModalId').value;
        const pay = Number(document.getElementById('colModalPay').value);
        const rem = document.getElementById('colModalRemarks').value;
        const colDate = document.getElementById('collectionDate').value;
        if(!colDate) { alert("তারিখ দিন!"); return; }
        let data = store.getIncome();
        const idx = data.findIndex(i => String(i.id) === String(id));
        if(idx !== -1) {
            data[idx].paid += pay; data[idx].due = data[idx].projected - data[idx].paid;
            data[idx].date = colDate;
            if(rem) data[idx].remarks = rem;
            sendToSheet('update', 'income', data[idx]);
            renderCollectionTable(); closeModal('collectionModal');
            // আগের কোড...
renderCollectionTable(); 
closeModal('collectionModal');

// এই লাইনটি যোগ করুন (Add this line):
document.getElementById('collectionDate').valueAsDate = new Date();


            alert("টাকা জমা হয়েছে!");
        }
    }
    function deleteIncome(id) {
        if(!confirm("আপনি কি নিশ্চিত?")) return;
        const index = globalData.income.findIndex(item => String(item.id) === String(id));
        if (index > -1) {
            globalData.income.splice(index, 1);
            sendToSheet('delete', 'income', {id: id});
            renderCollectionTable(); updateDashboard();
            alert("ডিলিট করা হয়েছে!");
        }
    }
    function openFullEditModal(id) {
        const item = store.getIncome().find(i => String(i.id) === String(id));
        if(!item) return;
        document.getElementById('editFullId').value = id;
        document.getElementById('editFullEn').value = item.english_name;
        document.getElementById('editFullBn').value = item.bengali_name;
        document.getElementById('editFullPara').value = item.para;
        document.getElementById('editFullProj').value = item.projected;
        document.getElementById('editFullPaid').value = item.paid;
        document.getElementById('fullEditModal').classList.remove('hidden');
    }
    function saveFullEdit() {
        const id = document.getElementById('editFullId').value;
        let data = store.getIncome();
        const idx = data.findIndex(i => String(i.id) === String(id));
        if(idx !== -1) {
            data[idx].english_name = document.getElementById('editFullEn').value;
            data[idx].bengali_name = document.getElementById('editFullBn').value;
            data[idx].para = document.getElementById('editFullPara').value;
            data[idx].projected = Number(document.getElementById('editFullProj').value);
            data[idx].paid = Number(document.getElementById('editFullPaid').value);
            data[idx].due = data[idx].projected - data[idx].paid;
            sendToSheet('update', 'income', data[idx]);
            renderCollectionTable(); closeModal('fullEditModal');
           
            alert("আপডেট হয়েছে!");
        }
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    // --- EXPENSE LOGIC ---
    async function handleExpInput(input) {
        const rawVal = input.value.trim();
        const topBox = document.getElementById('expPastSuggestions');
        const botBox = document.getElementById('expSuggestions');
        
        if (!rawVal) { topBox.classList.add('hidden'); botBox.classList.add('hidden'); return; }
        
        // 1. Past Suggestions
        topBox.innerHTML = ''; 
        const pastExp = store.getExpense();
        const matches = pastExp.filter(e => e.reason.toLowerCase().includes(rawVal.toLowerCase()));
        const uniqueMatches = [...new Set(matches.map(e => e.reason))];
        if(uniqueMatches.length > 0) {
            topBox.classList.remove('hidden');
            uniqueMatches.slice(0, 5).forEach(r => {
                const div = document.createElement('div'); div.className = 'suggestion-item';
                div.innerHTML = `<span class="font-bold text-gray-700">${r}</span> <span class="text-xs text-gray-400">Past</span>`;
                div.onclick = () => { input.value = r; topBox.classList.add('hidden'); botBox.classList.add('hidden'); };
                topBox.appendChild(div);
            });
        } else { topBox.classList.add('hidden'); }

        // 2. Custom Transliteration (Whale Fix)
        botBox.innerHTML = '';
        if (isBangla(rawVal)) {
            const toTitleCase = (str) => str.replace(/\b\w/g, char => char.toUpperCase());
            const autoEn = toTitleCase(transliterateBanglaToEnglish(rawVal));
            botBox.classList.remove('hidden');
            const div = document.createElement('div'); div.className = 'suggestion-item';
            div.innerHTML = `<span>${rawVal}</span> <span class="text-xs font-bold text-green-600">Auto: ${autoEn}</span>`;
            div.onclick = () => { input.value = `${autoEn} | ${rawVal}`; botBox.classList.add('hidden'); topBox.classList.add('hidden'); };
            botBox.appendChild(div);
        } else {
             try {
                const url = `https://inputtools.google.com/request?text=${encodeURIComponent(rawVal)}&itc=bn-t-i0-und&num=5&cp=0&cs=1&ie=utf-8&oe=utf-8`;
                const res = await fetch(url); const json = await res.json();
                if(json[0]==='SUCCESS'){
                    botBox.classList.remove('hidden');
                    const sugs = json[1][0][1];
                    sugs.forEach(s => {
                        const div = document.createElement('div'); div.className = 'suggestion-item';
                        div.innerHTML = `<span>${s}</span> <span class="text-xs text-green-600">Bangla</span>`;
                        div.onclick = () => { input.value = `${rawVal} | ${s}`; botBox.classList.add('hidden'); topBox.classList.add('hidden'); };
                        botBox.appendChild(div);
                    });
                }
            } catch(e){}
        }
    }
    function saveExpense() {
        const date = document.getElementById('expDate').value;
        const reason = document.getElementById('expReason').value;
        const amount = Number(document.getElementById('expAmount').value);
        if(!reason || !amount) { alert("তথ্য দিন"); return; }
        const item = { id: Date.now().toString(), date: date, reason: reason, amount: amount };
        globalData.expense.push(item);
        sendToSheet('add', 'expense', item);
        renderExpenseTable(); 
        document.getElementById('expReason').value = ''; document.getElementById('expAmount').value = '';
        // আগের কোড...
document.getElementById('expAmount').value = '';

// এই লাইনটি যোগ করুন (Add this line):
document.getElementById('expDate').valueAsDate = new Date();


        alert("খরচ সেভ হয়েছে!");
    }
    function initExpDropdown() {
        const data = store.getExpense();
        const select = document.getElementById('expFilterReason');
        const unique = [...new Set(data.map(d => d.reason))];
        select.innerHTML = '<option value="all">All</option>';
        unique.forEach(r => select.add(new Option(r, r)));
    }
   
   function renderExpenseTable() {
        const data = store.getExpense();
        const tbody = document.getElementById('expenseTableBody'); tbody.innerHTML = '';
        const start = document.getElementById('expStart').value;
        const end = document.getElementById('expEnd').value;
        const reason = document.getElementById('expFilterReason').value;
        const search = document.getElementById('expSearch').value.toLowerCase();
        
        data.forEach(row => {
            if(start && row.date < start) return;
            if(end && row.date > end) return;
            if(reason !== 'all' && row.reason !== reason) return;
            if(search && !row.reason.toLowerCase().includes(search)) return;
            
            const tr = document.createElement('tr'); tr.className = "hover:bg-red-50 border-b";
            
            // --- পরিবর্তন এখানে করা হয়েছে (Date Format Fix) ---
            // আগে ছিল: ${row.date}
            // এখন করা হলো: ${new Date(row.date).toLocaleDateString('en-GB')}
            
            tr.innerHTML = `
                <td class="p-3">${new Date(row.date).toLocaleDateString('en-GB')}</td>
                <td class="p-3 font-bold text-gray-700">${row.reason}</td>
                <td class="p-3 text-right font-mono">₹${row.amount}</td>
                <td class="p-3 text-center">
                    <div class="flex justify-center gap-2">
                        <button onclick="openExpenseEdit('${row.id}')" class="bg-blue-100 text-blue-600 p-2 rounded hover:bg-blue-600 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteExpense('${row.id}')" class="bg-red-100 text-red-600 p-2 rounded hover:bg-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        lucide.createIcons();
    }
   
   
    function openExpenseEdit(id) {
        const item = store.getExpense().find(e => String(e.id) === String(id));
        if(!item) return;
        document.getElementById('editExpId').value = id;
        document.getElementById('editExpDate').value = item.date;
        document.getElementById('editExpReason').value = item.reason;
        document.getElementById('editExpAmount').value = item.amount;
        document.getElementById('expenseEditModal').classList.remove('hidden');
    }
    function saveExpenseEdit() {
        const id = document.getElementById('editExpId').value;
        let data = store.getExpense();
        const idx = data.findIndex(e => String(e.id) === String(id));
        if(idx !== -1) {
            data[idx].date = document.getElementById('editExpDate').value;
            data[idx].reason = document.getElementById('editExpReason').value;
            data[idx].amount = Number(document.getElementById('editExpAmount').value);
            sendToSheet('update', 'expense', data[idx]);
            renderExpenseTable(); closeModal('expenseEditModal');
            alert("আপডেট হয়েছে!");
        }
    }
    function deleteExpense(id) {
        if(!confirm("খরচটি ডিলিট করতে চান?")) return;
        const index = globalData.expense.findIndex(item => String(item.id) === String(id));
        if (index > -1) {
            globalData.expense.splice(index, 1);
            sendToSheet('delete', 'expense', {id: id});
            renderExpenseTable(); updateDashboard();
            alert("ডিলিট হয়েছে!");
        }
    }

    // --- CAR LOGIC ---
function formatCarNumberDisplay(input) {
    let val = input.value.toUpperCase().replace(/\s/g, '');
    
    // অটো ফরম্যাটিং (স্পেস দেওয়া)
    if (val.length >= 8) {
        const matchLong = val.match(/^([A-Z]{2})(\d{2})([A-Z]{1,2})(\d{4})$/);
        const matchShort = val.match(/^([A-Z]{2})(\d{2})(\d{4})$/);
        if (matchLong) input.value = `${matchLong[1]} ${matchLong[2]} ${matchLong[3]} ${matchLong[4]}`;
        else if (matchShort) input.value = `${matchShort[1]} ${matchShort[2]} ${matchShort[3]}`;
    }

    // সাজেশন লজিক
    const box = document.getElementById('carNumberSuggestions'); 
    box.innerHTML = '';

    if(val.length >= 4) {
        const last4 = val.slice(-4);
        const allCars = store.getCar();
        // শেষের ৪ ডিজিট মিললেই সাজেশন দেখাবে
        const matches = allCars.filter(c => c.carNumber.replace(/\s/g, '').endsWith(last4));
        
        if(matches.length > 0) {
            box.classList.remove('hidden');
            matches.slice(0,5).forEach(c => {
                const div = document.createElement('div'); 
                div.className = 'suggestion-item hover:bg-green-50 border-b p-2 cursor-pointer flex justify-between items-center';
                
                // সাজেশন আইটেমের ডিজাইন
                div.innerHTML = `
                    <div>
                        <span class="font-mono font-bold text-blue-700">${c.carNumber}</span>
                        <br><span class="text-xs text-gray-500">${c.type}</span>
                    </div>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">জমা নিন</span>
                `;
                
                // [গুরুত্বপূর্ণ পরিবর্তন] এখানে ক্লিক করলেই পেমেন্ট মোডাল খুলবে
                div.onclick = () => { 
                    input.value = c.carNumber; // ইনপুটে নাম্বার বসে যাবে
                    box.classList.add('hidden'); // বক্স বন্ধ হবে
                    openCarPaymentModal(c.id); // সরাসরি পেমেন্ট পপ-আপ খুলবে
                };
                
                box.appendChild(div);
            });
        } else { box.classList.add('hidden'); }
    } else { box.classList.add('hidden'); }
}


    function calcCarDue() { document.getElementById('carDue').value = Number(document.getElementById('carAmount').value) - Number(document.getElementById('carPaid').value); }
    function saveCarEntry() {
        const num = document.getElementById('carNumberInput').value;
        if(num.length < 4) { alert("Invalid Car Number"); return; }
        const selectedDate = document.getElementById('carEntryDate').value;
        const item = {
            id: Date.now().toString(), 
            carNumber: num, 
            type: document.querySelector('input[name="carType"]:checked').value,
            date: selectedDate, 
            paid: Number(document.getElementById('carPaid').value),
            due: Number(document.getElementById('carDue').value), 
            remarks: document.getElementById('carRemarks').value
        };
        globalData.car.push(item); sendToSheet('add', 'car', item); 
        renderCarTable(); 
        document.getElementById('carNumberInput').value = ''; document.getElementById('carPaid').value = ''; document.getElementById('carDue').value = ''; document.getElementById('carRemarks').value = '';
        // আগের কোড...
document.getElementById('carRemarks').value = '';

// এই লাইনটি যোগ করুন (Add this line):
document.getElementById('carEntryDate').valueAsDate = new Date();


        alert("Saved!");
    }


// এই ফাংশনটি <script> ট্যাগের ভেতরে বসবে
function renderCarTable() {
    const data = store.getCar(); 
    const tbody = document.getElementById('carTableBody'); 
    tbody.innerHTML = '';
    
    // ১. সার্চ বক্স থেকে ভ্যালু নেওয়া হচ্ছে
    const searchRaw = document.getElementById('carSearchInput').value.toLowerCase().trim();
    
    // ২. তারিখের ভ্যারিয়েন্ট তৈরি (যাতে '-' বা '/' দুটোই কাজ করে)
    const searchDateVariant = searchRaw.replace(/-/g, '/'); 

    // ডাটা সর্ট করা (নতুন তারিখ আগে)
    const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedData.forEach(c => {
        // ডাটাবেসের তারিখ ফরম্যাট করা
        const dateObj = new Date(c.date);
        const dateStr = dateObj.toLocaleDateString('en-GB'); // যেমন: 25/10/2026

        // ৩. ফিল্টারিং লজিক (সার্চ বক্স খালি না থাকলে খুঁজবে)
        if (searchRaw) {
            const matchDate = dateStr.includes(searchRaw) || dateStr.includes(searchDateVariant);
            const matchNo = c.carNumber.toLowerCase().includes(searchRaw);
            const matchType = c.type.toLowerCase().includes(searchRaw);
            const matchRem = (c.remarks || '').toLowerCase().includes(searchRaw);

            // কোনোটার সাথেই না মিললে এই রো (row) বাদ যাবে
            if (!matchDate && !matchNo && !matchType && !matchRem) return; 
        }

        // ৪. টেবিল রো তৈরি করা
        const tr = document.createElement('tr'); 
        tr.className = "hover:bg-blue-50 transition border-b";
        
        // রো-তে ক্লিক করলে পেমেন্ট মোডাল খুলবে
        const clickAction = `onclick="openCarPaymentModal('${c.id}')" style="cursor: pointer;"`;
        
        tr.innerHTML = `
            <td ${clickAction}>${dateStr}</td>
            <td ${clickAction} class="font-mono font-bold text-blue-800">${c.carNumber}</td>
            <td ${clickAction}>${c.type}</td>
            <td ${clickAction} class="text-right font-bold text-green-600">₹${c.paid}</td>
            <td ${clickAction} class="text-right font-bold text-red-600">₹${c.due}</td>
            <td ${clickAction} class="text-xs text-gray-500">${c.remarks || '-'}</td>
            <td class="text-center">
                <div class="flex justify-center gap-2">
                    <button onclick="openCarEditModal('${c.id}')" class="bg-blue-100 text-blue-600 p-2 rounded hover:bg-blue-600 transition"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deleteCar('${c.id}')" class="bg-red-100 text-red-600 p-2 rounded hover:bg-red-600 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // আইকনগুলো রেন্ডার করা
    lucide.createIcons();
}
    
    
    
    function openCarPaymentModal(id) {
        const item = store.getCar().find(c => String(c.id) === String(id));
        if(!item) return;
        const total = item.paid + item.due; 
        document.getElementById('carPayId').value = id;
        document.getElementById('carPayTitle').innerText = `${item.carNumber} (${item.type})`;
        document.getElementById('cpTotal').innerText = `₹${total}`;
        document.getElementById('cpPaid').innerText = `₹${item.paid}`;
        document.getElementById('cpDue').innerText = `₹${item.due}`;
        document.getElementById('carNewPay').value = '';
        document.getElementById('carNewRem').value = '';
        document.getElementById('carPaymentModal').classList.remove('hidden');
    }
    function saveCarPayment() {
        const id = document.getElementById('carPayId').value;
        const newPay = Number(document.getElementById('carNewPay').value);
        const newRem = document.getElementById('carNewRem').value;
        const idx = globalData.car.findIndex(c => String(c.id) === String(id));
        if(idx !== -1) {
            const oldPaid = globalData.car[idx].paid; const total = oldPaid + globalData.car[idx].due;
            globalData.car[idx].paid = oldPaid + newPay; globalData.car[idx].due = total - globalData.car[idx].paid;
            
            // Transaction History Logic in Remarks
            const today = new Date().toLocaleDateString('en-GB');
            const historyLog = ` [Paid: ₹${newPay} on ${today}]`;
            globalData.car[idx].remarks = (globalData.car[idx].remarks || '') + historyLog + (newRem ? ` - ${newRem}` : '');

            sendToSheet('update', 'car', globalData.car[idx]);
            renderCarTable(); closeModal('carPaymentModal');
            alert("টাকা জমা সফল হয়েছে!");
        }
    }
    function deleteCar(id) {
        if(!confirm("আপনি কি নিশ্চিত?")) return;
        const index = globalData.car.findIndex(c => String(c.id) === String(id));
        if (index > -1) {
            globalData.car.splice(index, 1);
            sendToSheet('delete', 'car', {id: id});
            renderCarTable(); updateDashboard();
            alert("ডিলিট হয়েছে!");
        }
    }
    function openCarEditModal(id) {
        const item = store.getCar().find(c => String(c.id) === String(id));
        if(!item) return;
        document.getElementById('ceId').value = id;
        document.getElementById('ceDate').value = item.date;
        document.getElementById('ceNo').value = item.carNumber;
        document.getElementById('ceType').value = item.type;
        document.getElementById('cePaid').value = item.paid;
        document.getElementById('ceAmount').value = item.paid + item.due;
        document.getElementById('ceRem').value = item.remarks;
        document.getElementById('carEditModal').classList.remove('hidden');
    }
    function saveCarFullEdit() {
        const id = document.getElementById('ceId').value;
        const idx = globalData.car.findIndex(c => String(c.id) === String(id));
        if(idx !== -1) {
            globalData.car[idx].date = document.getElementById('ceDate').value;
            globalData.car[idx].carNumber = document.getElementById('ceNo').value;
            globalData.car[idx].type = document.getElementById('ceType').value;
            const total = Number(document.getElementById('ceAmount').value);
            const paid = Number(document.getElementById('cePaid').value);
            globalData.car[idx].paid = paid;
            globalData.car[idx].due = total - paid;
            globalData.car[idx].remarks = document.getElementById('ceRem').value;
            sendToSheet('update', 'car', globalData.car[idx]);
            renderCarTable(); closeModal('carEditModal');
            alert("আপডেট হয়েছে!");
        }
    }

    // --- PARA SETTINGS ---
    function renderParaSettings() {
        const tbody = document.getElementById('paraSettingsTable'); tbody.innerHTML = '';
        let paras = store.getParas();
        if (!paras || paras.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="text-center p-4">কোনো পাড়া নেই।</td></tr>'; return; }
        paras.forEach((p, index) => {
            const data = parseParaData(p);
            const tr = document.createElement('tr'); tr.className = "border-b hover:bg-gray-50";
            tr.innerHTML = `
                <td class="px-6 py-4 font-bold text-gray-700">${data.name}</td><td class="px-6 py-4 text-right font-mono text-blue-600">₹${data.amount}</td>
                <td class="px-6 py-4 text-center">
                    <button onclick="openParaModal(${index})" class="text-blue-500 hover:text-blue-700 mx-2"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                    <button onclick="deletePara(${index})" class="text-red-500 hover:text-red-700 mx-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        lucide.createIcons();
    }
    function openParaModal(index = null) {
        const modal = document.getElementById('paraModal');
        document.getElementById('paraNameInput').value = '';
        document.getElementById('paraAmountInput').value = '';
        document.getElementById('paraEditIndex').value = '';
        modal.classList.remove('hidden');
        if (index !== null) {
            const paras = store.getParas();
            const data = parseParaData(paras[index]);
            document.getElementById('paraNameInput').value = data.name;
            document.getElementById('paraAmountInput').value = data.amount;
            document.getElementById('paraEditIndex').value = index;
        }
    }
    function savePara() {
        const name = document.getElementById('paraNameInput').value.trim();
        const amount = Number(document.getElementById('paraAmountInput').value);
        const indexStr = document.getElementById('paraEditIndex').value;
        if (!name) { alert("নাম লিখুন!"); return; }
        let paras = store.getParas();
        paras = paras.map(p => parseParaData(p)); // Clean all
        const newItem = { name: name, amount: amount };
        if (indexStr !== '') { paras[parseInt(indexStr)] = newItem; } else { paras.push(newItem); }
        store.setParas(paras);
        refreshUI(); closeModal('paraModal');
    }
    function deletePara(index) {
        if(!confirm("নিশ্চিত?")) return;
        let paras = store.getParas().map(p => parseParaData(p));
        paras.splice(index, 1);
        store.setParas(paras); refreshUI();
    }

    // --- LEGACY UPLOAD ---
    function processLegacyUpload() {
        const fileInp = document.getElementById('legacyFile');
        const type = document.getElementById('legacyType').value;
        if (!fileInp.files.length) { alert("ফাইল সিলেক্ট করুন!"); return; }
        
        const file = fileInp.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1}); // Raw Array
            
            const rows = json.slice(1); // Header বাদ
            let count = 0;

            if (type === 'income') {
                rows.forEach(r => {
                    const amt = r[3];
                    if (!amt && amt !== 0) return;
                    
                    // এখানে তারিখ নেই, তাই আজকের তারিখ বা ডিফল্ট বসবে
                    // তবে যদি এক্সেলে তারিখ কলাম থাকে (ধরি কলাম F/Index 5), তবে: normalizeDate(r[5])
                    
                    const item = {
                        id: Date.now().toString() + Math.random(),
                        date: new Date().toISOString().split('T')[0], // বা normalizeDate(r[5])
                        para: r[0] || 'Legacy',
                        english_name: r[1] || 'Unknown',
                        bengali_name: r[2] || r[1] || 'অজানা',
                        projected: Number(amt),
                        paid: Number(amt),
                        due: 0,
                        remarks: r[4] || 'Legacy Import'
                    };
                    globalData.income.push(item);
                    sendToSheet('add', 'income', item);
                    count++;
                });
            } else {
                rows.forEach(r => {
                    // ব্যয়ের ক্ষেত্রে তারিখ থাকে কলাম A তে (Index 0)
                    // Excel এর তারিখ যদি সংখ্যা (Serial) হিসেবে আসে
                    let cleanDate;
                    if (typeof r[0] === 'number') {
                        // Excel Serial Date to JS Date
                        cleanDate = new Date(Math.round((r[0] - 25569)*86400*1000)).toISOString().split('T')[0];
                    } else {
                        cleanDate = normalizeDate(r[0]); // টেক্সট হলে ঠিক করো
                    }

                    const item = {
                        id: Date.now().toString() + Math.random(),
                        date: cleanDate,
                        reason: r[1] + (r[2] ? ` (${r[2]})` : ''),
                        amount: Number(r[3]),
                    };
                    globalData.expense.push(item);
                    sendToSheet('add', 'expense', item);
                    count++;
                });
            }
            alert(`${count} টি এন্ট্রি সফলভাবে ইম্পোর্ট হয়েছে!`);
            refreshUI();
        };
        reader.readAsArrayBuffer(file);
    }
    // --- DASHBOARD & HISTORY ---
    function updateDashboard() {
        const today = new Date().toISOString().split('T')[0];
        const inc = store.getIncome(); const car = store.getCar(); const exp = store.getExpense();
        const todayInc = inc.filter(i => i.date === today).reduce((s, x) => s + x.paid, 0) + car.filter(c => c.date === today).reduce((s, x) => s + x.paid, 0);
        const todayExp = exp.filter(e => e.date === today).reduce((s, x) => s + x.amount, 0);
        const totalInc = inc.reduce((s,x) => s + x.paid, 0) + car.reduce((s,x) => s + x.paid, 0);
        const totalExp = exp.reduce((s,x) => s + x.amount, 0);
        document.getElementById('dashTodayInc').innerText = '₹' + todayInc;
        document.getElementById('dashTodayExp').innerText = '₹' + todayExp;
        document.getElementById('dashBalance').innerText = '₹' + (totalInc - totalExp);
    }
    function searchHistory() {
        const year = document.getElementById('histYear').value;
        const type = document.getElementById('histType').value;
        const source = document.getElementById('histSource').value;
        const keyword = document.getElementById('histSearch').value.toLowerCase();
        let results = []; let grandTotal = 0;
        if (type === 'income') {
            const bills = store.getIncome(); const cars = store.getCar();
            if (source === 'all' || source === 'para') {
                bills.forEach(item => { if (item.date.startsWith(year) && (!keyword || item.english_name.toLowerCase().includes(keyword) || item.bengali_name.includes(keyword) || item.para.toLowerCase().includes(keyword))) { results.push({ date: item.date, desc: `${item.english_name} (${item.bengali_name})`, source: `Para: ${item.para}`, amount: item.paid, remarks: item.remarks || '-' }); } });
            }
            if (source === 'all' || source === 'car') {
                cars.forEach(item => { if (item.date.startsWith(year) && (!keyword || item.carNumber.toLowerCase().includes(keyword) || item.type.toLowerCase().includes(keyword))) { results.push({ date: item.date, desc: `Car No: ${item.carNumber}`, source: `Type: ${item.type}`, amount: item.paid, remarks: item.remarks || '-' }); } });
            }
        } else {
            const expenses = store.getExpense();
            expenses.forEach(item => { if (item.date.startsWith(year) && (!keyword || item.reason.toLowerCase().includes(keyword))) { results.push({ date: item.date, desc: item.reason, source: 'Expense', amount: item.amount, remarks: '-' }); } });
        }
        const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = '';
        if (results.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-red-500 font-bold">কোনো তথ্য পাওয়া যায়নি!</td></tr>`; document.getElementById('historyTotal').classList.add('hidden'); return; }
        results.sort((a, b) => new Date(b.date) - new Date(a.date));
        results.forEach(row => {
            grandTotal += Number(row.amount);
            const tr = document.createElement('tr'); tr.className = "hover:bg-purple-50 transition";
            tr.innerHTML = `<td class="p-3 border">${row.date}</td><td class="p-3 border font-bold">${row.desc}</td><td class="p-3 border text-xs uppercase font-semibold text-gray-500">${row.source}</td><td class="p-3 border text-right font-mono font-bold">₹${row.amount}</td><td class="p-3 border text-sm">${row.remarks}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('histTotalAmount').innerText = '₹' + grandTotal; document.getElementById('historyTotal').classList.remove('hidden');
    }
    function toggleHistoryFilters() {
        const type = document.getElementById('histType').value;
        const sourceBox = document.getElementById('histSourceBox');
        if (type === 'income') sourceBox.classList.remove('hidden'); else sourceBox.classList.add('hidden');
    }
    
    // --- REPORT LOGIC (NEW) ---

    // ১. UI হ্যান্ডেল করা (কোনটা দেখা যাবে কোনটা যাবে না)
    function handleReportUI() {
        const type = document.getElementById('repType').value;
        const source = document.getElementById('repSource').value;
        
        const sourceBox = document.getElementById('repSourceBox');
        const subFilters = document.getElementById('repSubFilters');
        const paraListBox = document.getElementById('repParaListBox');
        const statusBox = document.getElementById('repStatusBox');

        // প্যারার লিস্ট লোড করা (যদি আগে না হয়ে থাকে)
        const paraSelect = document.getElementById('repParaSelect');
        if (paraSelect.options.length <= 1) {
            store.getParas().forEach(p => {
                const data = parseParaData(p);
                paraSelect.add(new Option(data.name, data.name));
            });
        }

        if (type === 'expense') {
            sourceBox.classList.add('hidden');
            subFilters.classList.add('hidden');
        } else {
            // Income
            sourceBox.classList.remove('hidden');
            subFilters.classList.remove('hidden');
            
            // Logic for Para List
            if (source === 'para') {
                paraListBox.classList.remove('hidden');
                statusBox.className = "w-full"; // Reset width
            } else if (source === 'car') {
                paraListBox.classList.add('hidden');
                statusBox.className = "w-full col-span-2"; // Full width
            } else { // All
                paraListBox.classList.add('hidden');
                statusBox.className = "w-full col-span-2";
            }
        }
    }

    // ২. রিপোর্ট জেনারেশন ফাংশন
 function generateReport() {
        // ১. ইনপুট নেওয়া
        const start = document.getElementById('repStart').value;
        const end = document.getElementById('repEnd').value;
        const type = document.getElementById('repType').value;
        const tbody = document.getElementById('repTableBody');
        const thead = document.getElementById('repTableHead');
        
        // ২. রেজাল্ট এরিয়া শো করা
        document.getElementById('reportResultArea').classList.remove('hidden');
        if(document.getElementById('printBtn')) document.getElementById('printBtn').classList.remove('hidden');
        if(document.getElementById('pdfBtn')) document.getElementById('pdfBtn').classList.remove('hidden');

        // টেবিল ক্লিয়ার করা
        tbody.innerHTML = '';
        thead.innerHTML = '';
        
        let results = [];
        let totalAmount = 0;
        let columns = [];

        // --- EXPENSE REPORT (খরচ) ---
        if (type === 'expense') {
            document.getElementById('repResultTitle').innerText = "খরচের রিপোর্ট (Expense Report)";
            columns = ["তারিখ", "বিবরণ (Reason)", "টাকা (Amount)"];
            
            let data = store.getExpense();
            
            // ডাটা চেক
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500 font-bold">কোনো খরচ এন্ট্রি নেই!</td></tr>';
                document.getElementById('repTotalDisplay').innerText = '0';
                return;
            }

            // ফিল্টার
            results = data.filter(item => {
                if(start && item.date < start) return false;
                if(end && item.date > end) return false;
                return true;
            });

            // হেডার সেট
            let headerRow = '<tr>'; columns.forEach(c => headerRow += `<th class="border p-2 text-left bg-gray-100">${c}</th>`); headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // যদি ফিল্টারের পর ডাটা না থাকে
            if(results.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500 font-bold">এই তারিখের মধ্যে কোনো খরচ নেই!</td></tr>';
                document.getElementById('repTotalDisplay').innerText = '0';
                return;
            }
            
            // রেন্ডার
            results.sort((a,b) => new Date(a.date) - new Date(b.date));
            results.forEach(r => {
                totalAmount += Number(r.amount) || 0;
                tbody.innerHTML += `<tr><td class="border p-2">${new Date(r.date).toLocaleDateString('en-GB')}</td><td class="border p-2 font-bold text-gray-700">${r.reason}</td><td class="border p-2 text-right font-mono font-bold">₹${r.amount}</td></tr>`;
            });

        } else {
            // --- INCOME REPORT (আয়) ---
            const source = document.getElementById('repSource').value;
            const paraFilter = document.getElementById('repParaSelect').value;
            const status = document.getElementById('repStatus').value;
            
            let sourceText = source === 'all' ? 'সব উৎস' : (source === 'para' ? 'পাড়া কালেকশন' : 'গাড়ির চাঁদা');
            document.getElementById('repResultTitle').innerText = `আয়ের রিপোর্ট - ${sourceText}`;
            
            columns = ["তারিখ", "নাম/গাড়ী", "উৎস", "ধার্য", "জমা (Paid)", "বাকী (Due)"];
            
            // ১. ডাটা আনা
            let rawData = [];
            const incomeData = store.getIncome() || [];
            const carData = store.getCar() || [];

            if (source === 'all') {
                rawData = [...incomeData.map(i => ({...i, type: 'para'})), ...carData.map(c => ({...c, type: 'car'}))];
            } else if (source === 'para') {
                rawData = incomeData.map(i => ({...i, type: 'para'}));
            } else if (source === 'car') {
                rawData = carData.map(c => ({...c, type: 'car'}));
            }

            // ডাটা চেক (যদি ডাটাবেস খালি থাকে)
            if(rawData.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500 font-bold">ডাটাবেসে কোনো তথ্য নেই! (Data Empty) - দয়া করে ডাটা এন্ট্রি করুন।</td></tr>';
                 document.getElementById('repTotalDisplay').innerText = '0';
                 return;
            }

            // ২. ফিল্টার অ্যাপ্লাই
            results = rawData.filter(item => {
                // তারিখ ফিল্টার
                if(start && item.date < start) return false;
                if(end && item.date > end) return false;

                // পাড়া ফিল্টার
                if (source === 'para' && paraFilter !== 'all' && item.para !== paraFilter) return false;

                // স্ট্যাটাস ফিল্টার (Safe Check)
                const paid = Number(item.paid) || 0;
                const due = Number(item.due) || 0;
                
                if (status === 'paid' && paid <= 0) return false;
                if (status === 'due' && due <= 0) return false;
                if (status === 'zero' && paid > 0) return false;
                
                return true;
            });

            // হেডার সেট
            let headerRow = '<tr>'; columns.forEach(c => headerRow += `<th class="border p-2 text-left bg-gray-100">${c}</th>`); headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // যদি ফিল্টারের পর রেজাল্ট খালি হয়
            if(results.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500 font-bold">ফিল্টার অনুযায়ী কোনো তথ্য পাওয়া যায়নি! তারিখ বা অপশন চেক করুন।</td></tr>'; 
                document.getElementById('repTotalDisplay').innerText = '0';
                return;
            }

            // ৩. রেন্ডার
            results.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            results.forEach(r => {
                let name = r.type === 'para' ? `${r.english_name} <br><span class="text-xs text-gray-500">${r.bengali_name}</span>` : `<span class="font-mono font-bold text-blue-800">${r.carNumber}</span><br><span class="text-xs text-gray-500">${r.type}</span>`;
                let src = r.type === 'para' ? r.para : 'Car Entry';
                
                let paidAmt = Number(r.paid) || 0;
                let dueAmt = Number(r.due) || 0;
                let projectedAmt = Number(r.projected) || (paidAmt + dueAmt);
                
                totalAmount += paidAmt;

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="border p-2 text-xs">${new Date(r.date).toLocaleDateString('en-GB')}</td>
                        <td class="border p-2">${name}</td>
                        <td class="border p-2 text-xs">${src}</td>
                        <td class="border p-2 text-right text-gray-400 font-mono">₹${projectedAmt}</td>
                        <td class="border p-2 text-right font-bold text-green-600 font-mono">₹${paidAmt}</td>
                        <td class="border p-2 text-right font-bold text-red-600 font-mono">₹${dueAmt}</td>
                    </tr>`;
            });
        }
        
        document.getElementById('repTotalDisplay').innerText = '₹' + totalAmount;
    }
   // এই ফাংশনটি আগের printReportResult এর বদলে বসান
function printReportResult() {
    // ১. বর্তমানে টেবিলে যা আছে তা কপি করা
    const reportTitle = document.getElementById('repResultTitle').innerText;
    const totalAmount = document.getElementById('repTotalDisplay').innerText;
    const tableContent = document.querySelector('#reportResultArea table').outerHTML;
    
    // ২. ফিল্টার ডেট রেঞ্জ নেওয়া (হেডারে দেখানোর জন্য)
    const startDate = document.getElementById('repStart').value;
    const endDate = document.getElementById('repEnd').value;
    const dateRangeStr = (startDate && endDate) ? 
        `সময়কাল: ${new Date(startDate).toLocaleDateString('en-GB')} থেকে ${new Date(endDate).toLocaleDateString('en-GB')}` : 
        `তারিখ: ${new Date().toLocaleDateString('en-GB')}`;

    // ৩. নতুন উইন্ডো খোলা
    const win = window.open('', '', 'height=800,width=1000');
    
    win.document.write(`
        <html>
        <head>
            <title>Puja Report Print</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            
            <style>
                body { font-family: 'Hind Siliguri', sans-serif; -webkit-print-color-adjust: exact; padding: 40px; }
                
                /* টেবিল ডিজাইন */
                table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                th { background-color: #f3f4f6 !important; border: 1px solid #9ca3af; padding: 8px; text-align: left; }
                td { border: 1px solid #d1d5db; padding: 6px; vertical-align: top; }
                
                /* সিগনেচার এরিয়া */
                .signature-box { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
                .sig-line { border-top: 1px solid black; width: 200px; text-align: center; padding-top: 5px; font-weight: bold; font-size: 12px; }
                
                /* প্রিন্টের সময় অপ্রয়োজনীয় জিনিস লুকানো */
                @media print {
                    @page { margin: 15mm; size: A4; }
                    body { padding: 0; }
                }
            </style>
        </head>
        <body>
            <div class="text-center mb-6 border-b-2 border-red-600 pb-4">
                <div class="flex justify-center items-center gap-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 7.5a4.5 4.5 0 1 1 4.5 4.5M12 7.5A4.5 4.5 0 1 0 7.5 12M12 7.5V9m-4.5 3a4.5 4.5 0 1 0 4.5 4.5M7.5 12H9m3 4.5V16.5m4.5-4.5a4.5 4.5 0 1 1-4.5-4.5M12 12h1.5"/></svg>
                    <h1 class="text-3xl font-bold text-red-700">শারদীয়া পুজো কমিটি ২০২৬</h1>
                </div>
                <p class="text-sm text-gray-600">সাং: সংগ্রামপুর, বসিরহাট, উত্তর ২৪ পরগনা</p>
                <div class="mt-4 flex justify-between items-end">
                    <div class="text-left">
                        <h2 class="text-xl font-bold text-gray-800">${reportTitle}</h2>
                        <p class="text-xs font-bold text-gray-500 mt-1">${dateRangeStr}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">Generated on: ${new Date().toLocaleString('en-GB')}</p>
                    </div>
                </div>
            </div>

            ${tableContent}

            <div class="flex justify-end mt-4">
                <div class="bg-gray-100 border border-gray-300 p-3 rounded w-64">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-700">সর্বমোট (Grand Total):</span>
                        <span class="font-bold text-xl text-blue-700">${totalAmount}</span>
                    </div>
                </div>
            </div>

            <div class="signature-box">
                <div class="sig-line">
                    হিসাবরক্ষক (Accountant)<br>
                    <span class="text-xs font-normal">Date: ______________</span>
                </div>
                <div class="sig-line">
                    সম্পাদক / সভাপতি<br>
                    <span class="text-xs font-normal">(Secretary / President)</span>
                </div>
            </div>

            <script>
                // লোড হওয়ার সাথে সাথে প্রিন্ট ডায়ালগ খুলবে
                setTimeout(() => { window.print(); window.close(); }, 800);
            <\/script>
        </body>
        </html>
    `);
    win.document.close();
}

function downloadReportPDF() {
    // ১. নাম জেনারেশন (Auto Filename)
    const reportTitle = document.getElementById('repResultTitle').innerText.replace(/\s+/g, '_');
    const dateStamp = new Date().toISOString().split('T')[0];
    const fileName = `${reportTitle}_${dateStamp}.pdf`;

    // ২. প্রিন্ট ডিজাইন তৈরি (Print Preview এর মতই)
    const tableContent = document.querySelector('#reportResultArea table').outerHTML;
    const totalAmount = document.getElementById('repTotalDisplay').innerText;
    const startDate = document.getElementById('repStart').value;
    const endDate = document.getElementById('repEnd').value;
    const dateRangeStr = (startDate && endDate) ? 
        `সময়কাল: ${new Date(startDate).toLocaleDateString('en-GB')} থেকে ${new Date(endDate).toLocaleDateString('en-GB')}` : 
        `তারিখ: ${new Date().toLocaleDateString('en-GB')}`;

    // PDF এর ভেতরের HTML টেমপ্লেট
    const content = `
        <div style="font-family: 'Hind Siliguri', sans-serif; padding: 20px; color: #1f2937;">
            <div style="text-align: center; border-bottom: 2px solid #dc2626; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="font-size: 24px; font-weight: bold; color: #b91c1c; margin: 0;">শারদীয়া পুজো কমিটি ২০২৬</h1>
                <p style="font-size: 12px; color: #4b5563; margin: 5px 0;">সাং: সংগ্রামপুর, বসিরহাট, উত্তর ২৪ পরগনা</p>
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px;">
                    <div style="text-align: left;">
                        <h2 style="font-size: 16px; font-weight: bold; margin: 0;">${document.getElementById('repResultTitle').innerText}</h2>
                        <p style="font-size: 10px; font-weight: bold; color: #6b7280; margin: 2px 0;">${dateRangeStr}</p>
                    </div>
                </div>
            </div>
            
            ${tableContent}

            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <div style="background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 10px; border-radius: 4px; width: 200px;">
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>সর্বমোট:</span>
                        <span style="color: #1d4ed8;">${totalAmount}</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 60px; display: flex; justify-content: space-between;">
                <div style="border-top: 1px solid black; width: 150px; text-align: center; font-size: 10px; padding-top: 5px;">হিসাবরক্ষক</div>
                <div style="border-top: 1px solid black; width: 150px; text-align: center; font-size: 10px; padding-top: 5px;">সম্পাদক / সভাপতি</div>
            </div>
        </div>
    `;

    // ৩. একটি অস্থায়ী এলিমেন্ট তৈরি করা
    const element = document.createElement('div');
    element.innerHTML = content;
    // স্টাইলিং ফিক্স (যাতে টেবিল ঠিকঠাক দেখায় PDF এ)
    const tables = element.getElementsByTagName('table');
    for(let t of tables) { 
        t.style.width = '100%'; 
        t.style.borderCollapse = 'collapse'; 
        t.style.fontSize = '10px';
    }
    const ths = element.getElementsByTagName('th');
    for(let t of ths) { t.style.background = '#e5e7eb'; t.style.border = '1px solid #9ca3af'; t.style.padding = '4px'; }
    const tds = element.getElementsByTagName('td');
    for(let t of tds) { t.style.border = '1px solid #d1d5db'; t.style.padding = '4px'; }

    // ৪. PDF জেনারেট এবং সেভ
    const opt = {
        margin:       0.4,
        filename:     fileName, // এখানে অটোমেটিক নাম সেট হবে
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    // বাটন লোডিং দেখানোর জন্য
    const btn = document.getElementById('pdfBtn');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Downloading...';

    html2pdf().set(opt).from(element).save().then(() => {
        btn.innerHTML = oldText; // রিসেট
    });
}

// --- ম্যানুয়াল রিফ্রেশ বাটন ফাংশন ---
function handleManualRefresh() {
    const icon = document.getElementById('refreshSpinner');
    
    // ১. আইকন ঘোরানো শুরু (Animation Start)
    if(icon) icon.classList.add('animate-spin');

    // ২. সার্ভার থেকে ডেটা আনা
    fetchAllData().then(() => {
        // ৩. কাজ শেষ হলে ১ সেকেন্ড পর থামা
        setTimeout(() => {
            if(icon) icon.classList.remove('animate-spin');
            // ইউজারকে ছোট্ট নোটিফিকেশন দেওয়া (চাইলে এই লাইন বাদ দিতে পারেন)
            // alert("ডেটা রিফ্রেশ হয়েছে!"); 
        }, 800);
    }).catch(err => {
        if(icon) icon.classList.remove('animate-spin');
        console.error(err);
    });
}

</script>
</body>
</html>
